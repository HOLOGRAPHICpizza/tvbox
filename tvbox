#!/usr/bin/bash

# this is the first file in the tvbox launch chain
# can be run directly or by irtvboxlaunch
# runs tvboxlaunchchain2.sh

# shellcheck source=tvbox.conf.example
source ~/.tvbox.conf

# make sure it's not already running
#TODO: make this use pgrep and actually find only our tvbox processes
if ps -ef | grep -v grep | grep "feh"; then
	echo "feh already running, abort" >&2
	exit 1
fi
if ps -ef | grep -v grep | grep "python3"; then
	echo "python3 already running, abort" >&2
	exit 1
fi

# splash screen
if [ "$1" != "--no-delay" ]; then
	feh "$TVBOX_DIR/images/tvbox-splash.png" &
	# this is to give it a chance to sync the time via NTP. ideally it should have an RTC.
	sleep $TVBOX_SPLASH_DELAY
	#TODO: use pkill and only target our tvbox process
	killall feh
fi

# are we already in a terminal window?
if [ "$TERM" == "xterm-256color" ]; then
	bash $TVBOX_DIR/tvboxlaunchchain2.sh
else
	lxterminal -t tvboxterm -e "bash $TVBOX_DIR/tvboxlaunchchain2.sh"
fi
