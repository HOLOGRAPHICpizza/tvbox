#!/usr/bin/bash

# this is the first file in the tvbox launch chain
# can be run directly or by irtvboxlaunch
# runs tvboxlaunchchain2.sh

if [ -r "$XDG_CONFIG_HOME/tvboxrc" ]; then
	source "$XDG_CONFIG_HOME/tvboxrc"
elif [ -r ~/.config/tvboxrc ]; then
	# shellcheck source=tvboxrc.example
	source ~/.config/tvboxrc
else
	echo "Could not load tvboxrc, abort" >&2
	exit 1
fi

# make sure it's not already running
if pgrep -fa 'feh.*tvbox.*'; then
	echo "feh tvbox already running, abort" >&2
	exit 1
fi
if pgrep -fa 'python.*tvbox.*'; then
	echo "python3 tvbox already running, abort" >&2
	exit 1
fi

# splash screen
# this is mostly to allow Raspberry Pi to sync time via NTP on startup. Ideally it would have an RTC instead.
if [ "$1" != "--no-delay" ]; then
	feh -F "$TVBOX_DIR/images/tvbox-splash.png" &

	sleep "$TVBOX_SPLASH_MIN"

	for (( i=1; i<=TVBOX_SPLASH_MAX; i++ )); do
		if timedatectl show --property=NTPSynchronized | grep yes; then
			break
		fi
		sleep 1
	done

	pkill -f 'feh.*tvbox.*'
fi

# are we already in a terminal window?
if [ "$TERM" == "xterm-256color" ]; then
	bash "$TVBOX_DIR/tvboxlaunchchain2.sh"
else
	lxterminal -t tvboxterm -e "bash $TVBOX_DIR/tvboxlaunchchain2.sh"
fi
